{"id":"bugsink-cli-dkw","title":"Support BUGSINK_PROJECT_ID environment variable for project configuration","description":"Enable reading project_id from BUGSINK_PROJECT_ID environment variable in addition to .bugsink config file. Environment variable takes precedence over config file. When env var is set, skip creating the config file.","status":"open","priority":2,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-02-04T14:25:35.58846+01:00","created_by":"Tomáš Landovský","updated_at":"2026-02-04T14:25:35.58846+01:00"}
{"id":"bugsink-cli-dkw.1","title":"Plan implementation","status":"closed","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-02-04T14:25:39.473046+01:00","created_by":"Tomáš Landovský","updated_at":"2026-02-04T14:28:56.114306+01:00","closed_at":"2026-02-04T14:28:56.114306+01:00","close_reason":"Closed","dependencies":[{"issue_id":"bugsink-cli-dkw.1","depends_on_id":"bugsink-cli-dkw","type":"parent-child","created_at":"2026-02-04T14:25:39.473731+01:00","created_by":"Tomáš Landovský"}],"comments":[{"id":1,"issue_id":"bugsink-cli-dkw.1","author":"Tomáš Landovský","text":"# Plan: Support BUGSINK_PROJECT_ID environment variable for project configuration\n\n## Branch\n`feature/bugsink-cli-dkw-env-var-project-id`\n\n## Overview\nCurrently, project_id is only read from the `.bugsink` dotfile in the current directory. This feature adds support for reading project_id from the `BUGSINK_PROJECT_ID` environment variable, with the environment variable taking precedence over the config file. When the env var is set, the CLI will skip creating the `.bugsink` config file.\n\nThe implementation follows the existing pattern used for `BUGSINK_API_KEY` and `BUGSINK_HOST` in the Config class, ensuring consistency across the codebase.\n\n## Key patterns to follow\n\n- `lib/bugsink/config.rb` lines 13-15: Follow the existing pattern for reading environment variables in the Config initializer\n- `lib/bugsink/config.rb` line 14: Use `ENV.fetch('KEY', default_value)` for variables with defaults, or `ENV['KEY']` for optional variables\n- `spec/bugsink/config_spec.rb` lines 9-15: Follow the existing test pattern for stubbing ENV variables using `allow(ENV).to receive(:[])` and `allow(ENV).to receive(:fetch)`\n\n## Files to change\n\n- [x] `lib/bugsink/config.rb` - Update `read_project_id` method to check environment variable first\n- [x] `lib/bugsink/config.rb` - Update `set_project_id` method to skip file creation when env var is set\n- [x] `spec/bugsink/config_spec.rb` - Add tests for BUGSINK_PROJECT_ID environment variable\n- [x] `README.md` - Update documentation to mention BUGSINK_PROJECT_ID environment variable\n- [x] `lib/bugsink/cli.rb` - Update help text to document the new environment variable (lines 398-403)\n\n## Watch out for\n\n- **Precedence logic**: Environment variable must take precedence over config file. The current `read_project_id` method only reads from the file. You'll need to check the env var first, then fall back to the file if not present.\n\n- **Skip file creation when env var is set**: The `set_project_id` method (line 30-33) currently always writes to the file. When `BUGSINK_PROJECT_ID` is set, this creates a confusing state where the env var is used but a file is also created. The implementation should detect if the env var is set and skip file creation with an appropriate message.\n\n- **Type conversion**: The env var will be a string, but project_id is used as an integer in the codebase. You'll need to convert it using `.to_i`. Watch out for invalid values - consider what happens if someone sets `BUGSINK_PROJECT_ID=abc`.\n\n- **nil vs 0**: `\"\".to_i` returns 0 in Ruby, but 0 is not a valid project ID. The current file-reading code returns `nil` when the file doesn't exist or doesn't match the pattern. Ensure consistency - invalid env var values should result in `nil`, not 0.\n\n- **Config#to_s display**: The `to_s` method (lines 39-46) displays project_id. Consider whether it should indicate the source (env var vs file) for debugging purposes. This is optional but would be helpful for users.\n\n## Implementation details\n\n### lib/bugsink/config.rb changes\n\n1. **Update `read_project_id` method** (lines 50-56):\n   ```ruby\n   def read_project_id\n     # Check environment variable first (takes precedence)\n     env_project_id = ENV['BUGSINK_PROJECT_ID']\n     if env_project_id \u0026\u0026 !env_project_id.empty?\n       parsed = env_project_id.to_i\n       return parsed if parsed \u003e 0  # Ensure it's a valid positive integer\n     end\n     \n     # Fall back to dotfile\n     return nil unless File.exist?(dotfile_path)\n     \n     content = File.read(dotfile_path).strip\n     match = content.match(/^PROJECT_ID=(\\d+)$/)\n     match ? match[1].to_i : nil\n   end\n   ```\n\n2. **Update `set_project_id` method** (lines 30-33):\n   ```ruby\n   def set_project_id(id)\n     if ENV['BUGSINK_PROJECT_ID'] \u0026\u0026 !ENV['BUGSINK_PROJECT_ID'].empty?\n       # Don't write to file if env var is set (env var takes precedence)\n       # Just update the in-memory value\n       @project_id = id\n       return\n     end\n     \n     File.write(dotfile_path, \"PROJECT_ID=#{id}\\n\")\n     @project_id = id\n   end\n   ```\n\n3. **Optional: Update `to_s` method** (lines 39-46) to show source:\n   ```ruby\n   def to_s\n     project_display = if project_id\n       source = ENV['BUGSINK_PROJECT_ID'] \u0026\u0026 !ENV['BUGSINK_PROJECT_ID'].empty? ? 'env' : 'file'\n       \"#{project_id} (from #{source})\"\n     else\n       'not set'\n     end\n     \n     \u003c\u003c~CONFIG\n       BugSink Configuration:\n         Host: #{host}\n         API Key: #{api_key ? \"#{api_key[0..8]}...#{api_key[-8..]}\" : 'not set'}\n         Project ID: #{project_display}\n     CONFIG\n   end\n   ```\n\n### lib/bugsink/cli.rb changes\n\nUpdate the help text (lines 398-403) to document the new environment variable:\n\n```ruby\nEnvironment Variables:\n  BUGSINK_API_KEY         API authentication token (required)\n  BUGSINK_HOST            API host (default: https://bugs.kopernici.cz)\n  BUGSINK_PROJECT_ID      Default project ID (takes precedence over .bugsink file)\n\nConfiguration File:\n  .bugsink                Project ID for current directory (ignored if BUGSINK_PROJECT_ID is set)\n```\n\n### spec/bugsink/config_spec.rb changes\n\nAdd new test cases for the environment variable behavior:\n\n1. **Test reading from environment variable**:\n   ```ruby\n   describe '#read_project_id' do\n     context 'when BUGSINK_PROJECT_ID is set' do\n       it 'returns project ID from environment variable' do\n         allow(ENV).to receive(:[]).with('BUGSINK_PROJECT_ID').and_return('42')\n         config = described_class.new\n         expect(config.project_id).to eq(42)\n       end\n       \n       it 'ignores .bugsink file when env var is set' do\n         # Create a .bugsink file\n         dotfile_path = File.join(Dir.pwd, '.bugsink')\n         File.write(dotfile_path, \"PROJECT_ID=99\\n\")\n         \n         allow(ENV).to receive(:[]).with('BUGSINK_PROJECT_ID').and_return('42')\n         config = described_class.new\n         expect(config.project_id).to eq(42)\n         \n         File.delete(dotfile_path) if File.exist?(dotfile_path)\n       end\n       \n       it 'returns nil for invalid env var value' do\n         allow(ENV).to receive(:[]).with('BUGSINK_PROJECT_ID').and_return('invalid')\n         config = described_class.new\n         expect(config.project_id).to be_nil\n       end\n       \n       it 'returns nil for zero value' do\n         allow(ENV).to receive(:[]).with('BUGSINK_PROJECT_ID').and_return('0')\n         config = described_class.new\n         expect(config.project_id).to be_nil\n       end\n       \n       it 'returns nil for empty string' do\n         allow(ENV).to receive(:[]).with('BUGSINK_PROJECT_ID').and_return('')\n         config = described_class.new\n         expect(config.project_id).to be_nil\n       end\n     end\n     \n     context 'when BUGSINK_PROJECT_ID is not set' do\n       it 'reads from .bugsink file' do\n         allow(ENV).to receive(:[]).with('BUGSINK_PROJECT_ID').and_return(nil)\n         dotfile_path = File.join(Dir.pwd, '.bugsink')\n         File.write(dotfile_path, \"PROJECT_ID=99\\n\")\n         \n         config = described_class.new\n         expect(config.project_id).to eq(99)\n         \n         File.delete(dotfile_path) if File.exist?(dotfile_path)\n       end\n     end\n   end\n   ```\n\n2. **Test set_project_id behavior with env var**:\n   ```ruby\n   describe '#set_project_id' do\n     context 'when BUGSINK_PROJECT_ID is set' do\n       it 'does not create .bugsink file' do\n         allow(ENV).to receive(:[]).with('BUGSINK_PROJECT_ID').and_return('42')\n         config = described_class.new\n         \n         dotfile_path = File.join(Dir.pwd, '.bugsink')\n         File.delete(dotfile_path) if File.exist?(dotfile_path)\n         \n         config.set_project_id(99)\n         expect(config.project_id).to eq(99)  # Updates in-memory value\n         expect(File.exist?(dotfile_path)).to be false  # File not created\n       end\n     end\n     \n     context 'when BUGSINK_PROJECT_ID is not set' do\n       it 'creates .bugsink file as normal' do\n         allow(ENV).to receive(:[]).with('BUGSINK_PROJECT_ID').and_return(nil)\n         config = described_class.new\n         \n         dotfile_path = File.join(Dir.pwd, '.bugsink')\n         File.delete(dotfile_path) if File.exist?(dotfile_path)\n         \n         config.set_project_id(42)\n         expect(config.project_id).to eq(42)\n         expect(File.exist?(dotfile_path)).to be true\n         expect(File.read(dotfile_path)).to eq(\"PROJECT_ID=42\\n\")\n         \n         File.delete(dotfile_path)\n       end\n     end\n   end\n   ```\n\n### README.md changes\n\nUpdate the Configuration section (around lines 19-39) to document the new environment variable:\n\n```markdown\n### Environment Variables\n\n**Required:**\n- `BUGSINK_API_KEY` - Your BugSink API authentication token\n\n**Optional:**\n- `BUGSINK_HOST` - API host (default: `https://bugs.kopernici.cz`)\n- `BUGSINK_PROJECT_ID` - Default project ID (takes precedence over `.bugsink` file)\n\n### Project Configuration\n\nThe CLI supports two ways to set a default project ID:\n\n1. **Environment Variable (recommended for CI/CD):**\n   ```bash\n   export BUGSINK_PROJECT_ID=8\n   ```\n\n2. **Local `.bugsink` file (recommended for development):**\n   ```bash\n   bugsink config set-project 8\n   # This creates .bugsink file with: PROJECT_ID=8\n   ```\n\n**Note:** The environment variable takes precedence over the `.bugsink` file. When `BUGSINK_PROJECT_ID` is set, the `config set-project` command will not create a `.bugsink` file.\n```\n\n## Testing approach\n\n### Unit tests\n- Test reading project_id from environment variable when set\n- Test precedence: env var over config file (create a .bugsink file, set env var, verify env var wins)\n- Test fallback to config file when env var not set\n- Test invalid env var values (empty string, non-numeric, zero, negative)\n- Test set_project_id skips file creation when env var is set\n- Test set_project_id creates file normally when env var not set\n\n### Integration tests\nRun the CLI manually to verify:\n```bash\n# Test 1: Env var works\nexport BUGSINK_PROJECT_ID=8\nbugsink config show  # Should show project_id=8\n\n# Test 2: Precedence works\necho \"PROJECT_ID=99\" \u003e .bugsink\nexport BUGSINK_PROJECT_ID=8\nbugsink config show  # Should show project_id=8, not 99\nrm .bugsink\n\n# Test 3: Fallback works\nunset BUGSINK_PROJECT_ID\necho \"PROJECT_ID=99\" \u003e .bugsink\nbugsink config show  # Should show project_id=99\nrm .bugsink\n\n# Test 4: set-project doesn't create file when env var set\nexport BUGSINK_PROJECT_ID=8\nbugsink config set-project 99\nls -la .bugsink  # Should not exist\nbugsink config show  # Should still show 8 from env\n\n# Test 5: Use with commands\nexport BUGSINK_PROJECT_ID=8\nbugsink issues list  # Should use project_id=8 without needing --project flag\n```\n\n### Edge cases from spec\n- Empty string env var: should be treated as not set, fall back to file\n- Zero or negative project_id: should be treated as invalid, return nil\n- Non-numeric env var: should be treated as invalid, return nil\n- Both env var and file present: env var wins\n- Neither env var nor file present: project_id is nil (existing behavior)\n\n## Documentation to update\n\n- [x] `README.md` - Configuration section (lines 19-39): Add BUGSINK_PROJECT_ID to environment variables list and explain precedence\n- [x] `README.md` - Quick Start section (lines 41-58): Add example of using env var\n- [x] `lib/bugsink/cli.rb` - Help text (lines 398-403): Add BUGSINK_PROJECT_ID to environment variables list\n\n## Summary\n\nThis is a straightforward enhancement that follows existing patterns in the codebase. The key points are:\n\n1. Check environment variable first in `read_project_id` method\n2. Skip file creation in `set_project_id` when env var is set\n3. Handle invalid values gracefully (return nil for non-positive integers)\n4. Add comprehensive tests for all scenarios\n5. Update documentation in multiple places\n\nThe implementation should be defensive about invalid values and clear about precedence rules. The behavior should feel natural to users familiar with environment variable patterns in other CLI tools.","created_at":"2026-02-04T13:27:49Z"}]}
{"id":"bugsink-cli-dkw.2","title":"Implement","status":"in_progress","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-02-04T14:25:40.059322+01:00","created_by":"Tomáš Landovský","updated_at":"2026-02-04T14:29:57.540574+01:00","dependencies":[{"issue_id":"bugsink-cli-dkw.2","depends_on_id":"bugsink-cli-dkw","type":"parent-child","created_at":"2026-02-04T14:25:40.05995+01:00","created_by":"Tomáš Landovský"},{"issue_id":"bugsink-cli-dkw.2","depends_on_id":"bugsink-cli-dkw.1","type":"blocks","created_at":"2026-02-04T14:25:46.320406+01:00","created_by":"Tomáš Landovský"}]}
{"id":"bugsink-cli-dkw.3","title":"Review","status":"open","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-02-04T14:25:40.529288+01:00","created_by":"Tomáš Landovský","updated_at":"2026-02-04T14:25:40.529288+01:00","dependencies":[{"issue_id":"bugsink-cli-dkw.3","depends_on_id":"bugsink-cli-dkw","type":"parent-child","created_at":"2026-02-04T14:25:40.529853+01:00","created_by":"Tomáš Landovský"},{"issue_id":"bugsink-cli-dkw.3","depends_on_id":"bugsink-cli-dkw.2","type":"blocks","created_at":"2026-02-04T14:25:46.380176+01:00","created_by":"Tomáš Landovský"}]}
